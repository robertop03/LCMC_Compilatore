name: simulate-prof-test

on:
    push:
        branches: [ "main" ]
    workflow_dispatch: {}

jobs:
    test-on-baseline:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout baseline (tag)
              uses: actions/checkout@v4
              with:
                  ref: baseline-ci-prof-test
                  fetch-depth: 0

            - name: Fetch triggering commit from main
              run: |
                  set -euo pipefail
                  git remote add student "${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}.git"
                  git fetch --no-tags --depth=1 student "${GITHUB_SHA}"

            - name: Overlay only the 7 allowed files
              run: |
                  set -euo pipefail

                  files=(
                      "compiler/AST.java"
                      "compiler/ASTGenerationSTVisitor.java"
                      "compiler/CodeGenerationASTVisitor.java"
                      "compiler/PrintEASTVisitor.java"
                      "compiler/SymbolTableASTVisitor.java"
                      "compiler/TypeCheckEASTVisitor.java"
                      "compiler/TypeRels.java"
                  )

                  for f in "${files[@]}"; do
                      if ! git cat-file -e "${GITHUB_SHA}:$f"; then
                          echo "Missing file in triggering commit: $f"
                          exit 1
                      fi
                      mkdir -p "$(dirname "$f")"
                      git show "${GITHUB_SHA}:$f" > "$f"
                  done

            - name: Setup JDK
              uses: actions/setup-java@v4
              with:
                  distribution: temurin
                  java-version: "17"

            - name: Build and test (Gradle)
              run: |
                  set -euo pipefail
                  if [ -f "./gradlew" ]; then
                      chmod +x ./gradlew
                      ./gradlew clean test --no-daemon
                  elif [ -f "pom.xml" ]; then
                      mvn -B clean test
                  elif [ -f "build.xml" ]; then
                      ant test
                  else
                      echo "No gradlew, pom.xml, or build.xml found. Add the right build command."
                      exit 1
                  fi